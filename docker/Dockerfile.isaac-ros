# Multi-stage Docker build for NVIDIA Isaac ROS
# Target size: < 10GB (due to CUDA and Isaac dependencies)
# Requires: NVIDIA GPU with CUDA support, nvidia-docker
# Usage: docker build -f Dockerfile.isaac-ros -t ai-robotics:isaac-ros .

# ============================================================
# Stage 1: NVIDIA CUDA Base with ROS 2
# ============================================================
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04 AS isaac-base

ENV DEBIAN_FRONTEND=noninteractive
ENV ROS_DISTRO=humble
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=all

# Install essential tools
RUN apt-get update && apt-get install -y \
    locales \
    lsb-release \
    gnupg2 \
    curl \
    wget \
    software-properties-common \
    && locale-gen en_US en_US.UTF-8 \
    && update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8

# Add ROS 2 repository
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
    http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" \
    | tee /etc/apt/sources.list.d/ros2.list > /dev/null

# Install ROS 2 Humble
RUN apt-get update && apt-get install -y \
    ros-${ROS_DISTRO}-desktop \
    ros-${ROS_DISTRO}-ros-base \
    python3-colcon-common-extensions \
    python3-rosdep \
    && rm -rf /var/lib/apt/lists/*

# Initialize rosdep
RUN rosdep init && rosdep update

# ============================================================
# Stage 2: Install Isaac ROS Dependencies
# ============================================================
FROM isaac-base AS isaac-deps

# Install Isaac ROS prerequisites
RUN apt-get update && apt-get install -y \
    git-lfs \
    cmake \
    build-essential \
    python3-pip \
    libssl-dev \
    libusb-1.0-0-dev \
    pkg-config \
    libgtk-3-dev \
    libglfw3-dev \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Isaac ROS packages (GPU-accelerated perception)
RUN apt-get update && apt-get install -y \
    ros-${ROS_DISTRO}-isaac-ros-visual-slam \
    ros-${ROS_DISTRO}-isaac-ros-apriltag \
    ros-${ROS_DISTRO}-isaac-ros-dnn-inference \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies for Isaac ROS
RUN pip3 install --no-cache-dir \
    numpy \
    opencv-python \
    torch \
    torchvision \
    --extra-index-url https://download.pytorch.org/whl/cu118

# ============================================================
# Stage 3: Install Nav2 and Perception Stack
# ============================================================
FROM isaac-deps AS isaac-nav

# Install Nav2 navigation stack (Module 3)
RUN apt-get update && apt-get install -y \
    ros-${ROS_DISTRO}-navigation2 \
    ros-${ROS_DISTRO}-nav2-bringup \
    ros-${ROS_DISTRO}-slam-toolbox \
    ros-${ROS_DISTRO}-robot-localization \
    && rm -rf /var/lib/apt/lists/*

# Install additional perception packages
RUN apt-get update && apt-get install -y \
    ros-${ROS_DISTRO}-depth-image-proc \
    ros-${ROS_DISTRO}-image-transport \
    ros-${ROS_DISTRO}-image-pipeline \
    ros-${ROS_DISTRO}-vision-opencv \
    && rm -rf /var/lib/apt/lists/*

# ============================================================
# Stage 4: Workspace Setup and Runtime
# ============================================================
FROM isaac-nav AS isaac-runtime

# Create workspace
RUN mkdir -p /root/isaac_ws/src
WORKDIR /root/isaac_ws

# Install VLA dependencies (Module 4)
RUN pip3 install --no-cache-dir \
    openai-whisper \
    anthropic \
    transformers \
    accelerate

# Copy entrypoint script
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Source ROS 2 setup in bashrc
RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> ~/.bashrc && \
    echo "source /root/isaac_ws/install/setup.bash 2>/dev/null || true" >> ~/.bashrc && \
    echo "export CUDA_HOME=/usr/local/cuda" >> ~/.bashrc && \
    echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/usr/local/cuda/lib64" >> ~/.bashrc

# Set up entrypoint
ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]

# ============================================================
# Metadata
# ============================================================
LABEL maintainer="AI & Humanoid Robotics Course"
LABEL description="NVIDIA Isaac ROS with Nav2 for Module 3 (AI-Robot Brain)"
LABEL version="1.0"
LABEL ros_distro="humble"
LABEL cuda_version="11.8"

# ============================================================
# Build & Run Instructions
# ============================================================
# PREREQUISITES:
#   - NVIDIA GPU with CUDA support
#   - nvidia-docker2 installed
#   - NVIDIA driver 535+
#
# Build:
#   docker build -f docker/Dockerfile.isaac-ros -t ai-robotics:isaac-ros .
#
# Run with GPU support:
#   docker run -it --rm \
#     --gpus all \
#     -e DISPLAY=$DISPLAY \
#     -v /tmp/.X11-unix:/tmp/.X11-unix \
#     ai-robotics:isaac-ros
#
# Run with workspace mount:
#   docker run -it --rm \
#     --gpus all \
#     -e DISPLAY=$DISPLAY \
#     -v /tmp/.X11-unix:/tmp/.X11-unix \
#     -v $(pwd)/src:/root/isaac_ws/src \
#     ai-robotics:isaac-ros
#
# Test CUDA availability:
#   docker run -it --rm --gpus all ai-robotics:isaac-ros python3 -c "import torch; print(torch.cuda.is_available())"
#
# Run Visual SLAM:
#   docker exec -it <container_id> ros2 launch isaac_ros_visual_slam isaac_ros_visual_slam.launch.py
#
# For Isaac Sim integration, install separately:
#   https://docs.omniverse.nvidia.com/isaacsim/latest/
