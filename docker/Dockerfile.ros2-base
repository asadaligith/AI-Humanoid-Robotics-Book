# Multi-stage Docker build for ROS 2 Humble Base
# Target size: < 2GB
# Usage: docker build -f Dockerfile.ros2-base -t ai-robotics:ros2-base .

# ============================================================
# Stage 1: Base ROS 2 Humble Installation
# ============================================================
FROM osrf/ros:humble-desktop AS ros2-base

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV ROS_DISTRO=humble
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Install essential build tools and dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    wget \
    curl \
    python3-pip \
    python3-colcon-common-extensions \
    python3-rosdep \
    python3-vcstool \
    && rm -rf /var/lib/apt/lists/*

# Initialize rosdep (if not already initialized)
RUN rosdep update || true

# ============================================================
# Stage 2: Development Tools and Dependencies
# ============================================================
FROM ros2-base AS ros2-dev

# Install additional ROS 2 packages for course examples
RUN apt-get update && apt-get install -y \
    ros-${ROS_DISTRO}-example-interfaces \
    ros-${ROS_DISTRO}-rqt* \
    ros-${ROS_DISTRO}-rviz2 \
    ros-${ROS_DISTRO}-demo-nodes-cpp \
    ros-${ROS_DISTRO}-demo-nodes-py \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies for VLA modules
RUN pip3 install --no-cache-dir \
    openai-whisper \
    anthropic \
    numpy \
    opencv-python-headless

# Create workspace directory
RUN mkdir -p /root/ros2_ws/src

# Set working directory
WORKDIR /root/ros2_ws

# ============================================================
# Stage 3: Runtime-optimized Image (Final)
# ============================================================
FROM ros2-dev AS ros2-runtime

# Copy entrypoint script
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Source ROS 2 setup in bashrc
RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> ~/.bashrc
RUN echo "source /root/ros2_ws/install/setup.bash 2>/dev/null || true" >> ~/.bashrc

# Set up entrypoint
ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]

# ============================================================
# Metadata
# ============================================================
LABEL maintainer="AI & Humanoid Robotics Course"
LABEL description="ROS 2 Humble base image for course modules 1-4"
LABEL version="1.0"
LABEL ros_distro="humble"

# ============================================================
# Build Instructions
# ============================================================
# Build: docker build -f docker/Dockerfile.ros2-base -t ai-robotics:ros2-base .
# Run:   docker run -it --rm ai-robotics:ros2-base
#
# With GUI support (Linux):
# docker run -it --rm \
#   -e DISPLAY=$DISPLAY \
#   -v /tmp/.X11-unix:/tmp/.X11-unix \
#   ai-robotics:ros2-base
#
# With workspace mount:
# docker run -it --rm \
#   -v $(pwd)/src:/root/ros2_ws/src \
#   ai-robotics:ros2-base
